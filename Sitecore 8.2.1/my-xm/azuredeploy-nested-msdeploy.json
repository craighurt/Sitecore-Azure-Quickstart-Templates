{
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "variables": {},
  "parameters": {
    "servicesDeploymentName": {
      "type": "string"
    },
    "cmMsdeployPackageurl": {
      "type": "securestring"
    },
    "cdMsdeployPackageurl": {
      "type": "securestring"
    },
    "licenseXml": {
      "type": "securestring"
    },
    "sitecoreAdminPassword": {
      "type": "securestring"
    }
  },
  "resources": [
    {
      "name": "[concat(reference(concat('Microsoft.Resources/deployments/', parameters('servicesDeploymentName')), '2015-01-01').outputs.cmWebAppName.value, '/MSDeploy')]",
      "type": "Microsoft.Web/sites/extensions",
      "location": "[reference(concat('Microsoft.Resources/deployments/', parameters('servicesDeploymentName')), '2015-01-01').outputs.cmWebAppLocation.value]",
      "apiVersion": "2015-08-01",
      "properties": {
        "packageUri": "[parameters('cmMsdeployPackageurl')]",
        "dbType": "SQL",
        "connectionString": "[reference(concat('Microsoft.Resources/deployments/', parameters('servicesDeploymentName')), '2015-01-01').outputs.msDeployConnectionString.value]",
        "setParameters": {
          "Application Path": "[reference(concat('Microsoft.Resources/deployments/', parameters('servicesDeploymentName')), '2015-01-01').outputs.cmWebAppName.value]",
          "Sitecore Admin New Password": "[parameters('sitecoreAdminPassword')]",
          "Core DB User Name": "[reference(concat('Microsoft.Resources/deployments/', parameters('servicesDeploymentName')), '2015-01-01').outputs.cmCoreSqldatabaseUsername.value]",
          "Core DB Password": "[reference(concat('Microsoft.Resources/deployments/', parameters('servicesDeploymentName')), '2015-01-01').outputs.cmCoreSqldatabasePassword.value]",
          "Core Admin Connection String": "[reference(concat('Microsoft.Resources/deployments/', parameters('servicesDeploymentName')), '2015-01-01').outputs.cmCoreAdminConnectionString.value]",
          "Core Connection String": "[reference(concat('Microsoft.Resources/deployments/', parameters('servicesDeploymentName')), '2015-01-01').outputs.coreConnectionString.value]",
          "Master DB User Name": "[reference(concat('Microsoft.Resources/deployments/', parameters('servicesDeploymentName')), '2015-01-01').outputs.cmMasterSqldatabaseUsername.value]",
          "Master DB Password": "[reference(concat('Microsoft.Resources/deployments/', parameters('servicesDeploymentName')), '2015-01-01').outputs.cmMasterSqldatabasePassword.value]",
          "Master Admin Connection String": "[reference(concat('Microsoft.Resources/deployments/', parameters('servicesDeploymentName')), '2015-01-01').outputs.cmMasterAdminConnectionString.value]",
          "Master Connection String": "[reference(concat('Microsoft.Resources/deployments/', parameters('servicesDeploymentName')), '2015-01-01').outputs.masterAdminConnectionString.value]",
          "Web DB User Name": "[reference(concat('Microsoft.Resources/deployments/', parameters('servicesDeploymentName')), '2015-01-01').outputs.cmWebSqldatabaseUsername.value]",
          "Web DB Password": "[reference(concat('Microsoft.Resources/deployments/', parameters('servicesDeploymentName')), '2015-01-01').outputs.cmWebSqldatabasePassword.value]",
          "Web Admin Connection String": "[reference(concat('Microsoft.Resources/deployments/', parameters('servicesDeploymentName')), '2015-01-01').outputs.cmWebAdminConnectionString.value]",
          "Web Connection String": "[reference(concat('Microsoft.Resources/deployments/', parameters('servicesDeploymentName')), '2015-01-01').outputs.webAdminConnectionString.value]",
          "Cloud Search Connection String": "[reference(concat('Microsoft.Resources/deployments/', parameters('servicesDeploymentName')), '2015-01-01').outputs.searchConnectionString.value]",
          "Application Insights Instrumentation Key": "[reference(concat('Microsoft.Resources/deployments/', parameters('servicesDeploymentName')), '2015-01-01').outputs.applicationInsightsInstrumentationKey.value]",
          "Application Insights Role": "CM",
          "KeepAlive Url": "[reference(concat('Microsoft.Resources/deployments/', parameters('servicesDeploymentName')), '2015-01-01').outputs.cmKeepAliveUrl.value]",
          "License Xml": "[parameters('licenseXml')]",
          "IP Security Client IP": "[reference(concat('Microsoft.Resources/deployments/', parameters('servicesDeploymentName')), '2015-01-01').outputs.securityClientIp.value]",
          "IP Security Client IP Mask": "[reference(concat('Microsoft.Resources/deployments/', parameters('servicesDeploymentName')), '2015-01-01').outputs.securityClientIpMask.value]"
        }
      }
    },
    {
      "name": "[concat(reference(concat('Microsoft.Resources/deployments/', parameters('servicesDeploymentName')), '2015-01-01').outputs.cdAppName.value, '/MSDeploy')]",
      "type": "Microsoft.Web/sites/extensions",
      "location": "[reference(concat('Microsoft.Resources/deployments/', parameters('servicesDeploymentName')), '2015-01-01').outputs.cdAppLocation.value]",
      "apiVersion": "2015-08-01",
      "dependsOn": [
        "[concat('Microsoft.Web/sites/', reference(concat('Microsoft.Resources/deployments/', parameters('servicesDeploymentName')), '2015-01-01').outputs.cmWebAppName.value, '/Extensions/MSDeploy')]"
      ],
      "properties": {
        "packageUri": "[parameters('cdMsdeployPackageurl')]",
        "dbType": "SQL",
        "connectionString": "[concat('Data Source=tcp:', reference(concat('Microsoft.Sql/servers/', variables('dbServerNameTidy')), variables('dbApiVersion')).fullyQualifiedDomainName, ',1433;Initial Catalog=master;User Id=', parameters('sqlserverLogin'), '@', variables('dbServerNameTidy'), ';Password=', parameters('sqlserverPassword'), ';')]",
        "setParameters": {
          "Application Path": "[reference(concat('Microsoft.Resources/deployments/', parameters('servicesDeploymentName')), '2015-01-01').outputs.cdAppLocation.value]",
          "Sitecore Admin New Password": "[parameters('sitecoreAdminPassword')]",
          "Core DB User Name": "[parameters('cdCoreSqldatabaseUsername')]",
          "Core DB Password": "[parameters('cdCoreSqldatabasePassword')]",
          "Core Admin Connection String": "[concat('Encrypt=True;TrustServerCertificate=False;Data Source=', reference(concat('Microsoft.Sql/servers/', variables('dbServerNameTidy')), variables('dbApiVersion')).fullyQualifiedDomainName, ',1433;Initial Catalog=',variables('coreDbNameTidy'),';User Id=', parameters('sqlserverLogin'), ';Password=', parameters('sqlserverPassword'), ';')]",
          "Core Connection String": "[concat('Encrypt=True;TrustServerCertificate=False;Data Source=', reference(concat('Microsoft.Sql/servers/', variables('dbServerNameTidy')), variables('dbApiVersion')).fullyQualifiedDomainName, ',1433;Initial Catalog=',variables('coreDbNameTidy'),';User Id=', parameters('cdCoreSqldatabaseUsername'), ';Password=', parameters('cdCoreSqldatabasePassword'), ';')]",
          "Web DB User Name": "[parameters('cdWebSqldatabaseUsername')]",
          "Web DB Password": "[parameters('cdWebSqldatabasePassword')]",
          "Web Admin Connection String": "[concat('Encrypt=True;TrustServerCertificate=False;Data Source=', reference(concat('Microsoft.Sql/servers/', variables('webDbServerNameTidy')), variables('dbApiVersion')).fullyQualifiedDomainName, ',1433;Initial Catalog=',variables('webDbNameTidy'),';User Id=', parameters('webSqlserverLogin'), ';Password=', parameters('webSqlserverPassword'), ';')]",
          "Web Connection String": "[concat('Encrypt=True;TrustServerCertificate=False;Data Source=', reference(concat('Microsoft.Sql/servers/', variables('webDbServerNameTidy')), variables('dbApiVersion')).fullyQualifiedDomainName, ',1433;Initial Catalog=',variables('webDbNameTidy'),';User Id=', parameters('cdWebSqldatabaseUsername'), ';Password=', parameters('cdWebSqldatabasePassword'), ';')]",
          "Cloud Search Connection String": "[concat('serviceUrl=https://', variables('searchServiceNameTidy'), '.search.windows.net;apiVersion=', variables('searchApiVersion'), ';apiKey=', listAdminKeys(resourceId('Microsoft.Search/searchServices', variables('searchServiceNameTidy')), variables('searchApiVersion')).primaryKey)]",
          "Application Insights Instrumentation Key": "[reference(concat('Microsoft.Insights/Components/', variables('appInsightsNameTidy')), variables('appInsightsApiVersion')).InstrumentationKey]",
          "Application Insights Role": "CD",
          "KeepAlive Url": "[concat('https://', reference(concat('Microsoft.Web/sites/', variables('cdWebAppNameTidy')), variables('webApiVersion')).hostNames[0], '/sitecore/service/keepalive.aspx')]",
          "Redis Connection String": "[concat(reference(concat('Microsoft.Cache/Redis/', variables('redisCacheNameTidy')), variables('redisApiVersion')).hostName, ':', reference(concat('Microsoft.Cache/Redis/', variables('redisCacheNameTidy')), variables('redisApiVersion')).sslPort, ',password=', listKeys(resourceId('Microsoft.Cache/Redis', variables('redisCacheNameTidy')), variables('redisApiVersion')).primaryKey, ',ssl=True,abortConnect=False')]",
          "License Xml": "[parameters('licenseXml')]"
        }
      }
    }
  ]
}